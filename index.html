<!DOCTYPE html>
<html>
	<head>
		<title>2048 solver</title>
		<script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js"></script>
		<link rel='stylesheet' href="./styles.css">
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,100..700;1,100..700&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
	</head>
	<body>
		<script type="text/javascript">
			async function main(){
				let pyodide = await loadPyodide();
				await pyodide.loadPackage("micropip");
				const micropip = pyodide.pyimport("micropip");
				await micropip.install("a_star_2048");

				let namespace = pyodide.globals.get("dict")();

				cells = document.getElementsByClassName("cell")
				
				const initial_board = pyodide.runPython(`
				from a_star_2048 import init_board, move_board, spawn_value
				board = init_board()
				board
					`,{globals: namespace}).toJs().flat();


				for (let i = 0; i < cells.length; i++) {
					if (initial_board[i] != 0) {
						cells[i].innerHTML = initial_board[i]
						cells[i].classList.add(`cell-${initial_board[i]}`)
					} else {
						cells[i].innerHTML = ""
					}
				}

				const onKeyDown = (event) => {
					const movementForKey = new Map([
					['w', 'up'],
					['a','left'],
					['s', 'down'],
					['d', 'right'],
					['ArrowUp', 'up'],
					['ArrowLeft', 'left'],
					['ArrowDown', 'down'],
					['ArrowRight', 'right']
					]
					)
					const pressedKey = movementForKey.get(event.key)

					namespace.set("key",pressedKey)

					
					if(pressedKey) {
						let new_board = pyodide.runPython(`
							from a_star_2048 import move_board, spawn_value

							new_board = move_board(board,key)

							if new_board != board:
								board = new_board
								spawn_value(board)
							board
						`,{globals: namespace}).toJs().flat();
						
						
						for (let i = 0; i < cells.length; i++) {
							const clearClasses = [
									'cell-2',
									'cell-4',
									'cell-8',
									'cell-16',
									'cell-32',
									'cell-64',
									'cell-128',
									'cell-256',
									'cell-512',
									'cell-1024',
									'cell-2048'
								]

							cells[i].classList.remove(...clearClasses)
							cells[i].classList.add(`cell-${new_board[i]}`)

							if (new_board[i] != 0) {
								cells[i].innerHTML = new_board[i]
							} else {
								cells[i].innerHTML = ''
							}
						}

						let finished = pyodide.runPython(`
							from a_star_2048 import is_finished
							
							is_finished(board)
						`,{globals: namespace});

						if (finished && new_board.includes(2048)) {
								window.alert("You won")	
								document.body.removeEventListener("keydown",callback)
							} else if (finished) {
								window.alert("You lose")
								document.body.removeEventListener("keydown",callback)
							}
						}
					}

				document.body.addEventListener("keydown",callback = onKeyDown)
					}
					main();
		</script>
		<main>
			<h1>2048 Solver with A Star algorithm</h1>
			<div class='board'>
				<div class='cell' id='0-0'></div>
				<div class='cell' id='0-1'></div>
				<div class='cell' id='0-2'></div>
				<div class='cell' id='0-3'></div>
				<div class='cell' id='1-0'></div>
				<div class='cell' id='1-1'></div>
				<div class='cell' id='1-2'></div>
				<div class='cell' id='1-3'></div>
				<div class='cell' id='2-0'></div>
				<div class='cell' id='2-1'></div>
				<div class='cell' id='2-2'></div>
				<div class='cell' id='2-3'></div>
				<div class='cell' id='3-0'></div>
				<div class='cell' id='3-1'></div>
				<div class='cell' id='3-2'></div>
				<div class='cell' id='3-3'></div>
			</div>
		</main>
	</body>
</html>
