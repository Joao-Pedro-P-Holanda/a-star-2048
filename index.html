<!DOCTYPE html>
<html>
	<head>
		<title>2048 solver</title>
		<script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js"></script>
		<link rel='stylesheet' href="./styles.css">
	</head>
	<body>
		<script type="text/javascript">
			async function main(){
				let pyodide = await loadPyodide();
				await pyodide.loadPackage("micropip");
				const micropip = pyodide.pyimport("micropip");
				await micropip.install("a_star_2048");

				let namespace = pyodide.globals.get("dict")();

				cells = document.getElementsByClassName("cell")
				
				const initial_board = pyodide.runPython(`
				from a_star_2048 import init_board, move_board, spawn_value
				board = init_board()
				board
					`,{globals: namespace}).toJs().flat();


				for (let i = 0; i < cells.length; i++) {
					if (initial_board[i] != 0) {
						cells[i].innerHTML = initial_board[i]
					} else {
						cells[i].innerHTML = ""
					}
				}

				document.body.addEventListener("keydown",(event)=>{
					const movementForKey = new Map([
					['w', 'up'],
					['a','left'],
					['s', 'down'],
					['d', 'right']
					]
					)
					const pressedKey = movementForKey.get(event.key)

					namespace.set("key",pressedKey)

					
					if(pressedKey) {
						let new_board= pyodide.runPython(`
							from a_star_2048 import move_board, spawn_value

							new_board = move_board(board,key)
							if new_board != board:
								board = new_board
								spawn_value(board)
							board
						`,{globals: namespace}).toJs().flat();
						
						
						for (let i = 0; i < cells.length; i++) {
							if (new_board[i] != 0) {
								cells[i].innerHTML = new_board[i]
							} else {
								cells[i].innerHTML = ''
							}
						}
						if (new_board.includes(2048)) {
								window.alert("You won")	
							}
						}
						})
					}
					main();
		</script>
		<main>
			<h1>2048 Solver with A Star algorithm</h1>
			<div class='board'>
				<div class='cell' id='0-0'></div>
				<div class='cell' id='0-1'></div>
				<div class='cell' id='0-2'></div>
				<div class='cell' id='0-3'></div>
				<div class='cell' id='1-0'></div>
				<div class='cell' id='1-1'></div>
				<div class='cell' id='1-2'></div>
				<div class='cell' id='1-3'></div>
				<div class='cell' id='2-0'></div>
				<div class='cell' id='2-1'></div>
				<div class='cell' id='2-2'></div>
				<div class='cell' id='2-3'></div>
				<div class='cell' id='3-0'></div>
				<div class='cell' id='3-1'></div>
				<div class='cell' id='3-2'></div>
				<div class='cell' id='3-3'></div>
			</div>
		</main>
	</body>
</html>
